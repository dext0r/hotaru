automation:
  - id: automations_turn_off
    alias: 'Automations: Turn off'
    trigger:
      platform: event
      event_type: yandex_intent
      event_data:
        text: –í—ã–∫–ª—é—á–∏ –≤—Å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É
    action:
      - service: automation.turn_off
        entity_id: all
        data:
          stop_actions: false

      - service: automation.turn_on
        entity_id: automation.automations_turn_on

      - service: script.yandex_station_tts
        data:
          target: >
            {{ trigger.event.data.get('entity_id', 'last') }}
          text: '–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –¥–æ–º —Å–Ω–æ–≤–∞ –≥–ª—É–ø—ã–π. –ß—Ç–æ –±—ã –≤–∫–ª—é—á–∏—Ç—å –≤—Å–µ –Ω–∞–∑–∞–¥, —Å–∫–∞–∂–∏: –ê–ª–∏—Å–∞, –≤–∫–ª—é—á–∏ –≤—Å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É'

  - id: automations_turn_on
    alias: 'Automations: Turn on'
    trigger:
      platform: event
      event_type: yandex_intent
      event_data:
        text: –í–∫–ª—é—á–∏ –≤—Å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: automation.automations_turn_on
                state: 'on'
            sequence:
              - service: script.yandex_station_tts
                data:
                  target: >
                    {{ trigger.event.data.get('entity_id', 'last') }}
                  text: –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –≤—Å—ë —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        default:
          - service: automation.turn_on
            entity_id: all

          - service: script.yandex_station_tts
            data:
              target: >
                {{ trigger.event.data.get('entity_id', 'last') }}
              text: –í–∫–ª—é—á–∏–ª–∞, –Ω–µ –¥–µ–ª–∞–π –±–æ–ª—å—à–µ —Ç–∞–∫, –º–Ω–µ —Å—Ç—Ä–∞—à–Ω–æ –∏ –æ–±–∏–¥–Ω–æ

  - id: everybody_left_home
    alias: Everybody Left Home
    trigger:
      - platform: state
        entity_id: binary_sensor.anyone_home
        from: 'on'
        to: 'off'
    action:
      - service: input_datetime.set_datetime
        entity_id: input_datetime.anyone_home_last_seen
        data:
          datetime: '{{ now().strftime("%Y-%m-%d %H:%M:%S") }}'

  - id: anyone_home_last_seen_update
    alias: 'Anyone Home Last Seen: Update'
    trigger:
      - platform: time_pattern
        minutes: /4
    condition:
      - condition: state
        entity_id: binary_sensor.anyone_home
        state: 'on'
    action:
      - service: input_datetime.set_datetime
        entity_id: input_datetime.anyone_home_last_seen
        data:
          datetime: '{{ now().strftime("%Y-%m-%d %H:%M:%S") }}'

  - id: home_mode_day_auto_turn_on
    alias: 'Home Mode Day: Auto turn on'
    trigger:
      - platform: time
        at: '13:00'
    condition:
      - condition: state
        entity_id: binary_sensor.anyone_home
        state: 'on'

      - condition: not
        conditions:
          - condition: state
            entity_id: input_select.home_mode
            state: Day
    action:
      - service: input_select.select_option
        entity_id: input_select.home_mode
        data:
          option: Day

  - id: home_mode_night_auto_turn_on
    alias: 'Home Mode Night: Auto turn on'
    trigger:
      - platform: time
        at: '01:55'
    condition:
      - condition: state
        entity_id: binary_sensor.anyone_home
        state: 'on'

      - condition: state
        entity_id: binary_sensor.motion_anywhere
        state: 'off'
        for:
          hours: 1

      - condition: not
        conditions:
          - condition: state
            entity_id: input_select.home_mode
            state: Night
    action:
      - service: input_select.select_option
        entity_id: input_select.home_mode
        data:
          option: Night

  - id: home_mode_manual_day
    alias: 'Home Mode: Manual day'
    trigger:
      - platform: event
        event_type: yandex_intent
        event_data:
          text: –°–µ–π—á–∞—Å –¥–µ–Ω—å
    action:
      - if:
          - condition: state
            entity_id: input_select.home_mode
            state: Day
        then:
          - service: script.yandex_station_tts
            data:
              target: >
                {{ trigger.event.data.get('entity_id', 'last') }}
              text: –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ, —Å–µ–π—á–∞—Å –¥–µ–Ω—å
        else:
          - service: input_select.select_option
            entity_id: input_select.home_mode
            data:
              option: Day

          - service: script.yandex_station_tts
            data:
              target: >
                {{ trigger.event.data.get('entity_id', 'last') }}
              text: –ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∞ –¥–æ–º –≤ –¥–Ω–µ–≤–Ω–æ–π —Ä–µ–∂–∏–º

  - id: home_mode_to_vacation_alert
    alias: 'Home Mode: To vacation alert'
    trigger:
      platform: state
      entity_id: input_select.home_mode
      to: Vacation
    action:
      - service: notify.dextor
        data:
          message: üå¥ –î–æ–º –ø–µ—Ä–µ–≤—ë–¥–µ–Ω –≤ —Ä–µ–∂–∏–º –æ—Ç–ø—É—Å–∫–∞

  - id: home_mode_from_vacation_alert
    alias: 'Home Mode: From vacation alert'
    trigger:
      platform: state
      entity_id: input_select.home_mode
      from: Vacation
    action:
      - service: notify.dextor
        data:
          message: üòü –î–æ–º –≤–æ–∑–≤—Ä–∞—â—ë–Ω –∏–∑ —Ä–µ–∂–∏–º–∞ –æ—Ç–ø—É—Å–∫–∞

input_select:
  home_mode:
    name: Home Mode
    options:
      - Day
      - Night
      - Vacation

input_datetime:
  anyone_home_last_seen:
    name: 'Anyone Home: Last Seen'
    has_time: true
    has_date: true
    icon: mdi:exit-to-app

template:
  - binary_sensor:
      - name: Anyone Home
        state: >
          {{ states('zone.home')|int(0) > 0 }}
        device_class: presence

  - sensor:
      - name: Alert Greeting
        icon: mdi:account-voice
        state: >
          {%- if is_state('person.layma', 'home') and not is_state('person.dextor', 'home') -%}
            –ú–∞—Ä–∏–Ω–æ—á–∫–∞,
          {%- endif -%}

      - name: Person Pronoun Gen
        icon: mdi:account-voice
        state: >
          {%- if states.person | selectattr('state', 'eq', 'home') | list | count < 2 -%}
            —Ç–µ–±—è
          {%- else -%}
            –≤–∞—Å
          {%- endif -%}

      - name: Person Pronoun Nom
        icon: mdi:account-voice
        state: >
          {%- if states.person | selectattr('state', 'eq', 'home') | list | count < 2 -%}
            —Ç—ã
          {%- else -%}
            –≤—ã
          {%- endif -%}

      - name: Chores
        icon: mdi:broom
        state: >
          {% set data = namespace(chores=[]) %}
          {% if is_state('input_select.dishwasher_status', 'Dirty') %}
            {% set data.chores = data.chores + ['–≤–∫–ª—é—á–∏—Ç—å –ø–æ—Å—É–¥–æ–º–æ–π–∫—É'] %}
          {% endif %}

          {% if is_state('input_boolean.living_room_humidifier_on_duty', 'on') and
                states('sensor.living_room_humidifier_water_level')|int(100) <= 50 %}
            {% set data.chores = data.chores + ['–¥–æ–ª–∏—Ç—å –≤–æ–¥—ã –≤ –≥–æ—Å—Ç–∏–Ω–æ–π'] %}
          {% endif %}

          {% if is_state('input_boolean.bedroom_humidifier_on_duty', 'on') and
                states('sensor.bedroom_humidifier_water_level')|int(100) <= 50 %}
            {% set data.chores = data.chores + ['–¥–æ–ª–∏—Ç—å –≤–æ–¥—ã –≤ —Å–ø–∞–ª—å–Ω–µ'] %}
          {% endif %}

          {% if states('sensor.kettle_water_level')|int(100) <= 20 %}
            {% set data.chores = data.chores + ['–¥–æ–ª–∏—Ç—å –≤–æ–¥—ã –≤ —á–∞–π–Ω–∏–∫'] %}
          {% endif %}

          {% if is_state('binary_sensor.front_door', 'on') %}
            {% set data.chores = data.chores + ['–∑–∞–∫—Ä—ã—Ç—å –≤—Ö–æ–¥–Ω—É—é –¥–≤–µ—Ä—å, –∞ —Ç–æ —è –Ω–µ —Å–º–æ–≥–ª–∞'] %}
          {% endif %}

          {% if is_state('binary_sensor.bedroom_window', 'on') %}
            {% set data.chores = data.chores + ['–∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –≤ —Å–ø–∞–ª—å–Ω–µ'] %}
          {% endif %}

          {% if is_state('binary_sensor.workshop_window', 'on') %}
            {% set data.chores = data.chores + ['–∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –≤ –º–∞—Å—Ç–µ—Ä—Å–∫–æ–π'] %}
          {% endif %}

          {% if is_state('binary_sensor.living_room_balcony_door', 'on') %}
            {% set data.chores = data.chores + ['–∑–∞–∫—Ä—ã—Ç—å –±–∞–ª–∫–æ–Ω –≤ –≥–æ—Å—Ç–∏–Ω–æ–π'] %}
          {% endif %}

          {{- data.chores|join(', ') -}}

      - name: Input Voltage
        device_class: voltage
        unit_of_measurement: V
        state: >
          {{ states('sensor.ups_input_voltage')|float(0) }}
        availability: >
          {{ states('sensor.ups_input_voltage') not in ['unavailable', 'unknown'] }}

      - name: Energy Tariff
        unit_of_measurement: RUB/kWh
        state: '3.37'

  - trigger:
      - platform: time_pattern
        seconds: /5
    binary_sensor:
      - name: Motion Anywhere
        state: >
          {% set ns = namespace(break = false) %}
          {%- for state in states.binary_sensor if ns.break == false and
                                                  state.state == 'on' and
                                                  state.attributes.get('device_class') == 'motion' and
                                                  state.entity_id not in (
                                                    'binary_sensor.motion_anywhere',
                                                    'binary_sensor.wardrobe_motion',
                                                    'binary_sensor.porch_motion'
                                                  ) -%}
            {%- set ns.break = true -%}
            true
          {%- endfor -%}
        device_class: motion
